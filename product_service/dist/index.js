"use strict";var it=Object.create;var M=Object.defineProperty;var ct=Object.getOwnPropertyDescriptor;var dt=Object.getOwnPropertyNames;var pt=Object.getPrototypeOf,Rt=Object.prototype.hasOwnProperty;var mt=(e,t,r,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of dt(t))!Rt.call(e,o)&&o!==r&&M(e,o,{get:()=>t[o],enumerable:!(a=ct(t,o))||a.enumerable});return e};var f=(e,t,r)=>(r=e!=null?it(pt(e)):{},mt(t||!e||!e.__esModule?M(r,"default",{value:e,enumerable:!0}):r,e));var n=(e,t,r)=>new Promise((a,o)=>{var u=p=>{try{d(r.next(p))}catch(I){o(I)}},i=p=>{try{d(r.throw(p))}catch(I){o(I)}},d=p=>p.done?a(p.value):Promise.resolve(p.value).then(u,i);d((r=r.apply(e,t)).next())});var et=f(require("cookie-parser")),T=f(require("express")),ot=f(require("helmet")),st=f(require("cors"));var s={OK:200,CREATED:201,BAD_REQUEST:400,UNAUTHORIZED:401,CONFLICT:409,MISSING_CREDS:422,SERVER_ERROR:500};var $=require("express"),k=(0,$.Router)();k.get("/healthcheck",(e,t)=>t.status(s.OK).json({status:"OK",message:"healthy"}));var N=k;var v=f(require("dotenv"));if(process.env.NODE_ENV!=="prod"){let e=`./.env.${process.env.NODE_ENV}`;v.default.config({path:e})}else v.default.config();var Et={PORT:process.env.PORT||8e3,DB_URL:process.env.DB_URL,TOKEN_SECRET:process.env.TOKEN_SECRET,CUSTOMER_SERVICE_URL:process.env.CUSTOMER_SERVICE_URL,SHOPPING_SERVICE_URL:process.env.SHOPPING_SERVICE_URL},g=Et;var y=require("winston");var P=class extends Error{constructor(t,r,a,o,u,i){super(a),Object.setPrototypeOf(this,new.target.prototype),this.name=t,this.statusCode=r,this.description=a,this.isOperational=o,this.errorStack=u,this.loggingErrorResponse=i,Error.captureStackTrace(this)}},c=class extends P{constructor(t,r=s.SERVER_ERROR,a="internal server error",o){super(t,r,a,o)}};var{combine:J,timestamp:Y,label:W,printf:lt,colorize:K}=y.format,z=lt(({level:e,message:t,label:r,timestamp:a})=>`[${a}] ${r} ${e}: ${t}`),E=(0,y.createLogger)({format:J(W({label:"\u{1F680}"}),K(),Y({format:"DD-MM-YYYY HH:mm:ssA Z"}),z),transports:[new y.transports.Console]}),ft=(0,y.createLogger)({format:J(W({label:"\u{1F680}"}),K(),Y({format:"DD-MM-YYYY HH:mm:ssA Z"}),z),transports:[new y.transports.Console,new y.transports.File({filename:"app_error.log"})]}),w=class{constructor(){this.logError=t=>n(this,null,function*(){return console.log("==================== Start Error Logger ==============="),ft.log({private:!0,level:"error",message:`${new Date} - ${JSON.stringify(t)}`}),console.log("==================== End Error Logger ==============="),!1});this.isTrustError=t=>t instanceof P?t.isOperational:!1}};var G=f(require("mongoose"));var gt=()=>n(void 0,null,function*(){try{yield G.default.connect(g.DB_URL),E.info("DB Connected...")}catch(e){E.error(`Failed to Connect DB : ${e}`)}}),b=gt;var F=f(require("mongoose")),yt=F.default.Schema,St=new yt({name:{type:String,required:!0},type:{type:String,required:!0},banner:{type:String,required:!0},suplier:{type:String,required:!0},description:{type:String,required:!0},unit:{type:Number,required:!0},price:{type:Number,required:!0},available:{type:Boolean,required:!0}},{timestamps:!0,toJSON:{transform(e,t){delete t.__v}}}),O=F.default.model("product",St);var A=class{createProduct(I){return n(this,arguments,function*({name:t,type:r,unit:a,price:o,banner:u,suplier:i,available:d,description:p}){try{return yield O.create({name:t,type:r,unit:a,price:o,banner:u,suplier:i,available:d,description:p})}catch(D){throw new c("API ERROR",s.SERVER_ERROR,"unable to create product")}})}products(){return n(this,null,function*(){try{return yield O.find()}catch(t){throw new c("API ERROR",s.SERVER_ERROR,"unable to find products")}})}findById(t){return n(this,null,function*(){try{return yield O.findById(t)}catch(r){throw new c("API ERROR",s.SERVER_ERROR,"unable to find product")}})}findByCategory(t){return n(this,null,function*(){try{return yield O.find({type:t})}catch(r){throw new c("API ERROR",s.SERVER_ERROR,"unable to find products")}})}findSelectedProducts(t){return n(this,null,function*(){try{return yield O.find().where("_id").in(t).exec()}catch(r){throw new c("API ERROR",s.SERVER_ERROR,"unable to find products")}})}},B=A;var V=f(require("axios")),Q=f(require("jsonwebtoken"));var Z=e=>{try{let t=e.get("Authorization");if(!t)return!1;let r=Q.default.verify(t.split(" ")[1],g.TOKEN_SECRET);return e.user=r,!0}catch(t){return E.error("Error :",JSON.stringify(t)),!1}},_=e=>{if(e)return{data:e};throw new Error("Data Not found!")},x=e=>n(void 0,null,function*(){try{return yield V.default.post(`${g.CUSTOMER_SERVICE_URL}/app-events`,{payload:e}),!0}catch(t){return!1}}),q=e=>n(void 0,null,function*(){try{return yield V.default.post(`${g.SHOPPING_SERVICE_URL}/app-events`,{payload:e}),!0}catch(t){return!1}});var j=class{constructor(){this.repository=new B}createProduct(t){return n(this,null,function*(){try{let r=yield this.repository.createProduct(t);return _(r)}catch(r){throw new c("Failed to create product",s.SERVER_ERROR,JSON.stringify(r))}})}getProducts(){return n(this,null,function*(){try{let t=yield this.repository.products(),r={};return t.forEach(({type:a})=>{r[a]=a}),_({products:t,categories:Object.keys(r)})}catch(t){throw new c("Failed to get products",s.SERVER_ERROR,JSON.stringify(t))}})}getProductDetails(t){return n(this,null,function*(){try{let r=yield this.repository.findById(t);return _(r)}catch(r){throw new c("Failed to get product",s.SERVER_ERROR,JSON.stringify(r))}})}getProductsByCategory(t){return n(this,null,function*(){try{let r=yield this.repository.findByCategory(t);return _(r)}catch(r){throw new c("Failed to get products",s.SERVER_ERROR,JSON.stringify(r))}})}getProductsByIds(t){return n(this,null,function*(){try{let r=yield this.repository.findSelectedProducts(t);return _(r)}catch(r){throw new c("Failed to get products",s.SERVER_ERROR,JSON.stringify(r))}})}getProductPayload(u){return n(this,arguments,function*({customerId:t,productId:r,qty:a,event:o}){let i=yield this.getProductDetails(r);return i?_({event:o,data:{customerId:t,product:i,qty:a}}):!1})}},X=j;var ht=e=>(t,r,a)=>Promise.resolve(e(t,r,a)).catch(a),R=ht;var S=new X,U=class{constructor(){this.create=R((t,r,a)=>n(this,null,function*(){let{name:o,desc:u,type:i,unit:d,price:p,available:I,suplier:D,banner:at}=t.body,{data:ut}=yield S.createProduct({name:o,type:i,unit:d,price:p,banner:at,suplier:D,available:I,description:u});return r.status(s.CREATED).json(ut)}));this.getByCategory=R((t,r,a)=>n(this,null,function*(){let o=t.params.type,{data:u}=yield S.getProductsByCategory(o);return r.status(s.CREATED).json(u)}));this.getById=R((t,r,a)=>n(this,null,function*(){let o=t.params.id,{data:u}=yield S.getProductDetails(o);return r.status(s.CREATED).json(u)}));this.getByIds=R((t,r,a)=>n(this,null,function*(){let{ids:o}=yield t.body,{data:u}=yield S.getProductsByIds(o);return r.status(s.CREATED).json(u)}));this.addToWishlist=R((t,r,a)=>n(this,null,function*(){if(t.user){let o=yield S.getProductPayload({customerId:t.user._id,productId:t.body._id,event:"ADD_TO_WISHLIST"});if(o){let{data:u}=o;return x(u),r.status(s.CREATED).json(u.data.product)}else return r.status(s.SERVER_ERROR).json({status:"ERROR"})}return r.status(s.SERVER_ERROR).json({status:"ERROR"})}));this.removeFromWishlist=R((t,r,a)=>n(this,null,function*(){if(t.user){let o=yield S.getProductPayload({customerId:t.user._id,productId:t.params.id,event:"REMOVE_FROM_WISHLIST"});if(o){let{data:u}=o;return x(u),r.status(s.CREATED).json(u.data.product)}else return r.status(s.SERVER_ERROR).json({status:"ERROR"})}return r.status(s.SERVER_ERROR).json({status:"ERROR"})}));this.addToCart=R((t,r,a)=>n(this,null,function*(){if(t.user){let{_id:o,qty:u}=t.body,i=yield S.getProductPayload({customerId:t.user._id,productId:o,qty:u,event:"ADD_TO_CART"});if(i){let{data:d}=i;return x(d),q(d),r.status(s.CREATED).json({product:d.data.product,unit:d.data.qty})}else return r.status(s.SERVER_ERROR).json({status:"ERROR"})}return r.status(s.SERVER_ERROR).json({status:"ERROR"})}));this.removeFromCart=R((t,r,a)=>n(this,null,function*(){if(t.user){let{qty:o}=t.body,u=yield S.getProductPayload({customerId:t.user._id,productId:t.params.id,qty:o,event:"REMOVE_FROM_CART"});if(u){let{data:i}=u;return x(i),q(i),r.status(s.CREATED).json({product:i.data.product,unit:i.data.qty})}else return r.status(s.SERVER_ERROR).json({status:"ERROR"})}return r.status(s.SERVER_ERROR).json({status:"ERROR"})}));this.getAllProducts=R((t,r,a)=>n(this,null,function*(){let{data:o}=yield S.getProducts();return r.status(s.CREATED).json(o)}));this.events=R((t,r,a)=>n(this,null,function*(){if(!t.body.payload)return r.status(s.BAD_REQUEST).json({status:"ERROR"});let{payload:o}=t.body;return E.info("===========Product Service Received Event==========="),r.status(s.CREATED).json(o)}))}},L=U;var Ot=(e,t,r)=>n(void 0,null,function*(){if(Z(e))r();else return t.status(s.UNAUTHORIZED).json({status:"ERROR",message:"unauthorized user"})}),C=Ot;var tt=require("express"),m=(0,tt.Router)(),l=new L;m.post("/create",l.create);m.post("/ids",l.getByIds);m.put("/wishlist",C,l.addToWishlist);m.delete("/wishlist/:id",C,l.removeFromWishlist);m.put("/cart",C,l.addToCart);m.delete("/cart/:id",C,l.removeFromCart);m.get("/all",l.getAllProducts);m.get("/category/:type",l.getByCategory);m.get("/:id",l.getById);m.post("/app-events",l.events);var H=m;var _t=(e,t,r,a)=>n(void 0,null,function*(){let o=new w;if(process.on("uncaughtException",u=>{throw console.log(u,"UNHANDLED"),u}),process.on("uncaughtException",u=>{o.logError(u),o.isTrustError(e)}),e){if(yield o.logError(e),o.isTrustError(e)){if(e.errorStack){let u=e.errorStack;return r.status(e.statusCode).json({message:u})}return r.status(e.statusCode).json({message:e.message})}return r.status(e.statusCode).json({message:e.message})}a()}),rt=_t;var h=(0,T.default)();h.use((0,st.default)());h.use(T.default.json({limit:"1mb"}));h.use(T.default.urlencoded({extended:!0,limit:"1mb"}));h.use((0,et.default)());h.use((0,ot.default)());h.use("/product",N);h.use("/product",H);h.use(rt);var nt=h;var It=()=>{b(),nt.listen(g.PORT,()=>{E.info(`product service running on PORT: ${g.PORT}`)}).on("error",()=>{E.error("Failed to start server"),process.exit()})};It();
