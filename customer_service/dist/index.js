"use strict";var Rt=Object.create;var K=Object.defineProperty;var mt=Object.getOwnPropertyDescriptor;var lt=Object.getOwnPropertyNames;var ft=Object.getPrototypeOf,gt=Object.prototype.hasOwnProperty;var Et=(s,t,e,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of lt(t))!gt.call(s,o)&&o!==e&&K(s,o,{get:()=>t[o],enumerable:!(r=mt(t,o))||r.enumerable});return s};var l=(s,t,e)=>(e=s!=null?Rt(ft(s)):{},Et(t||!s||!s.__esModule?K(e,"default",{value:s,enumerable:!0}):e,s));var a=(s,t,e)=>new Promise((r,o)=>{var n=d=>{try{c(e.next(d))}catch(m){o(m)}},u=d=>{try{c(e.throw(d))}catch(m){o(m)}},c=d=>d.done?r(d.value):Promise.resolve(d.value).then(n,u);c((e=e.apply(s,t)).next())});var at=l(require("cookie-parser")),T=l(require("express")),it=l(require("helmet")),ut=l(require("cors"));var i={OK:200,CREATED:201,BAD_REQUEST:400,UNAUTHORIZED:401,CONFLICT:409,MISSING_CREDS:422,SERVER_ERROR:500};var H=require("express"),$=(0,H.Router)();$.get("/healthcheck",(s,t)=>t.status(i.OK).json({status:"OK",message:"healthy"}));var N=$;var v=l(require("dotenv"));if(process.env.NODE_ENV!=="prod"){let s=`./.env.${process.env.NODE_ENV}`;v.default.config({path:s})}else v.default.config();var ht={PORT:process.env.PORT||8001,DB_URL:process.env.DB_URL,TOKEN_SECRET:process.env.TOKEN_SECRET||""},y=ht;var h=require("winston");var I=class extends Error{constructor(t,e,r,o,n,u){super(r),Object.setPrototypeOf(this,new.target.prototype),this.name=t,this.statusCode=e,this.description=r,this.isOperational=o,this.errorStack=n,this.loggingErrorResponse=u,Error.captureStackTrace(this)}},p=class extends I{constructor(t,e=i.SERVER_ERROR,r="internal server error",o){super(t,e,r,o)}};var{combine:W,timestamp:Y,label:z,printf:yt,colorize:Q}=h.format,Z=yt(({level:s,message:t,label:e,timestamp:r})=>`[${r}] ${e} ${s}: ${t}`),R=(0,h.createLogger)({format:W(z({label:"\u{1F680}"}),Q(),Y({format:"DD-MM-YYYY HH:mm:ssA Z"}),Z),transports:[new h.transports.Console]}),wt=(0,h.createLogger)({format:W(z({label:"\u{1F680}"}),Q(),Y({format:"DD-MM-YYYY HH:mm:ssA Z"}),Z),transports:[new h.transports.Console,new h.transports.File({filename:"app_error.log"})]}),x=class{constructor(){this.logError=t=>a(this,null,function*(){return console.log("==================== Start Error Logger ==============="),wt.log({private:!0,level:"error",message:`${new Date} - ${JSON.stringify(t)}`}),console.log("==================== End Error Logger ==============="),!1});this.isTrustError=t=>t instanceof I?t.isOperational:!1}};var G=l(require("mongoose"));var St=()=>a(void 0,null,function*(){try{yield G.default.connect(y.DB_URL),R.info("DB Connected...")}catch(s){R.error(`Failed to Connect DB : ${s}`)}}),b=St;var A=l(require("mongoose")),Ot=A.default.Schema,It=new Ot({street:{type:String,required:!0},postalCode:{type:String,required:!0},city:{type:String,required:!0},country:{type:String,required:!0}},{toJSON:{transform(s,t){delete t.__v}}}),D=A.default.model("address",It);var P=l(require("mongoose")),X=P.default.Schema,_t=new X({email:{type:String,required:!0},password:{type:String,required:!0},phone:{type:String,required:!0},address:[{type:X.Types.ObjectId,ref:"address",required:!0}],wishlist:[{_id:{type:String,required:!0},name:{type:String},banner:{type:String},price:{type:Number},description:{type:String},available:{type:Boolean}}],orders:[{_id:{type:String,required:!0},amount:{type:String},date:{type:Date,default:new Date().toISOString()}}],cart:[{product:{_id:{type:String,required:!0},name:{type:String},banner:{type:String},price:{type:Number}},unit:{type:Number,required:!0}}]},{timestamps:!0,toJSON:{transform(s,t){delete t.password,delete t.__v}}}),f=P.default.model("customer",_t);var V=class{createCustomer(o){return a(this,arguments,function*({email:t,password:e,phone:r}){try{return yield f.create({email:t,password:e,phone:r,address:[]})}catch(n){throw new p("API ERROR",i.SERVER_ERROR,"unable to add customer")}})}createAddress(u){return a(this,arguments,function*({customerId:t,city:e,postalCode:r,street:o,country:n}){try{let c=yield f.findById(t);if(c){let d=yield D.create({city:e,postalCode:r,street:o,country:n});c.address.push(d),yield c.save()}return c}catch(c){throw new p("API ERROR",i.SERVER_ERROR,"unable to add address")}})}findCustomer(t){return a(this,null,function*(){try{return yield f.findOne({email:t})}catch(e){throw new p("API ERROR",i.SERVER_ERROR,"unable to find customer")}})}findCustomerById(t){return a(this,null,function*(){try{return yield f.findById(t).populate("address")}catch(e){throw new p("API ERROR",i.SERVER_ERROR,"unable to find customer")}})}wishlist(t){return a(this,null,function*(){try{let e=yield f.findById(t).populate("wishlist");return e==null?void 0:e.wishlist}catch(e){throw new p("API ERROR",i.SERVER_ERROR,"unable to find customer")}})}addWishlistItem(t,e){return a(this,null,function*(){try{let r=yield f.findById(t).populate("wishlist");if(r){let n=r.wishlist;if(n.length>0){let u=!1;n.map((c,d)=>{String(c._id)===String(e._id)&&(n.splice(d,1),u=!0)}),u||n.push(e)}else n.push(e);r.wishlist=n}let o=yield r==null?void 0:r.save();return o==null?void 0:o.wishlist}catch(r){throw new p("API ERROR",i.SERVER_ERROR,"unable to add to wishlist")}})}addCartItem(n){return a(this,arguments,function*({customerId:t,qty:e,product:r,isRemove:o}){try{let u=yield f.findById(t).populate("cart");if(u){let d={product:r,unit:e},m=u.cart;if(m.length>0){let C=!1;m.map((J,dt)=>{let pt=J.product;String(pt._id)===String(r._id)&&(C=!0,o?m.splice(dt,1):J.unit=e)}),C||m.push(d)}else m.push(d);u.cart=m}let c=yield u==null?void 0:u.save();return c==null?void 0:c.cart}catch(u){throw new p("API ERROR",i.SERVER_ERROR,"unable to add to cart")}})}addOrderToProfile(t,e){return a(this,null,function*(){try{let r=yield f.findById(t).populate("orders");return r&&(r.orders||(r.orders=[]),r.orders.push(e),r.cart=[]),yield r==null?void 0:r.save()}catch(r){throw new p("API ERROR",i.SERVER_ERROR,"unable to add order to profile")}})}},F=V;var q=l(require("argon2")),B=l(require("jsonwebtoken"));var tt=s=>a(void 0,null,function*(){return yield q.default.hash(s)}),et=(s,t)=>a(void 0,null,function*(){return yield q.default.verify(s,t)}),U=s=>B.default.sign(s,y.TOKEN_SECRET,{expiresIn:"30d"}),rt=s=>{try{let t=s.get("Authorization");if(!t)return!1;let e=B.default.verify(t.split(" ")[1],y.TOKEN_SECRET);return s.user=e,!0}catch(t){return R.error("Error :",JSON.stringify(t)),!1}},g=s=>{if(s)return{data:s};throw new Error("Data Not found!")};var j=class{constructor(){this.repository=new F}signIn(r){return a(this,arguments,function*({email:t,password:e}){try{let o=yield this.repository.findCustomer(t);if(o){if(yield et(o.password,e)){let{email:u,phone:c,_id:d}=o,C=U({email:u,phone:c,_id:d});return g({id:o._id,token:C})}return g(null)}}catch(o){throw new p("failed to sign in",i.SERVER_ERROR,JSON.stringify(o))}})}signUp(o){return a(this,arguments,function*({email:t,phone:e,password:r}){try{let n=yield tt(r),u=yield this.repository.createCustomer({email:t,phone:e,password:n}),c={email:t,phone:e,_id:u==null?void 0:u._id},d=U(c);return g({id:u._id,token:d})}catch(n){throw new p("failed to sign up",i.SERVER_ERROR,JSON.stringify(n))}})}addNewAddress(t){return a(this,null,function*(){try{let e=yield this.repository.createAddress(t);return g(e)}catch(e){throw new p("failed to add new address",i.SERVER_ERROR,JSON.stringify(e))}})}getProfile(t){return a(this,null,function*(){try{let e=yield this.repository.findCustomerById(t);return g(e)}catch(e){throw new p("failed to get customer profile",i.SERVER_ERROR,JSON.stringify(e))}})}getWishlist(t){return a(this,null,function*(){try{let e=yield this.repository.wishlist(t);return g(e)}catch(e){throw new p("failed to get customer wishlist",i.SERVER_ERROR,JSON.stringify(e))}})}addToWishlist(t,e){return a(this,null,function*(){try{let r=yield this.repository.addWishlistItem(t,e);return g(r)}catch(r){throw new p("failed to add item in customer wishlist",i.SERVER_ERROR,JSON.stringify(r))}})}manageCart(t){return a(this,null,function*(){try{let e=yield this.repository.addCartItem(t);return g(e)}catch(e){throw new p("failed to update cart",i.SERVER_ERROR,JSON.stringify(e))}})}manageOrder(t,e){return a(this,null,function*(){try{let r=yield this.repository.addOrderToProfile(t,e);return g(r)}catch(r){throw new p("failed to update order",i.SERVER_ERROR,JSON.stringify(r))}})}subscribeEvents(u){return a(this,arguments,function*({data:{customerId:t,order:e,qty:r,product:o},event:n}){switch(n){case"ADD_TO_WISHLIST":case"REMOVE_FROM_WISHLIST":t&&o&&this.addToWishlist(t,o);break;case"ADD_TO_CART":t&&o&&r&&this.manageCart({customerId:t,product:o,qty:r,isRemove:!1});break;case"REMOVE_FROM_CART":t&&o&&r&&this.manageCart({customerId:t,product:o,qty:r,isRemove:!0});break;case"CREATE_ORDER":t&&e&&this.manageOrder(t,e);break;case"TEST":R.info("======TEST_EVENT_RECEIVED=====");break;default:break}})}},st=j;var Ct=s=>(t,e,r)=>Promise.resolve(s(t,e,r)).catch(r),w=Ct;var L=class{constructor(){this.signup=w((t,e,r)=>a(this,null,function*(){let{email:o,password:n,phone:u}=t.body,{data:c}=yield this.service.signUp({email:o,phone:u,password:n});return e.status(i.CREATED).json(c)}));this.login=w((t,e,r)=>a(this,null,function*(){let{email:o,password:n}=t.body,u=yield this.service.signIn({email:o,password:n});return e.status(i.OK).json(u==null?void 0:u.data)}));this.address=w((t,e,r)=>a(this,null,function*(){if(t.user){let{_id:o}=t.user,{street:n,postalCode:u,city:c,country:d}=t.body,{data:m}=yield this.service.addNewAddress({customerId:o,city:c,street:n,country:d,postalCode:u});return e.status(i.OK).json(m)}return e.status(i.SERVER_ERROR).json({status:"ERROR"})}));this.profile=w((t,e,r)=>a(this,null,function*(){if(t.user){let{_id:o}=t.user,{data:n}=yield this.service.getProfile(o);return e.status(i.OK).json(n)}return e.status(i.SERVER_ERROR).json({status:"ERROR"})}));this.shoppingDetails=w((t,e,r)=>a(this,null,function*(){if(t.user){let{_id:o}=t.user,{data:n}=yield this.service.getProfile(o);return e.status(i.OK).json(n)}return e.status(i.SERVER_ERROR).json({status:"ERROR"})}));this.wishlist=w((t,e,r)=>a(this,null,function*(){if(t.user){let{_id:o}=t.user,{data:n}=yield this.service.getWishlist(o);return e.status(i.OK).json(n)}return e.status(i.SERVER_ERROR).json({status:"ERROR"})}));this.events=w((t,e,r)=>a(this,null,function*(){if(!t.body.payload)return e.status(i.BAD_REQUEST).json({status:"ERROR"});let o=t.body.payload;return this.service.subscribeEvents(o),R.info("======CUSTOMER SERVICE RECEIVED EVENT====="),e.status(i.OK).json(o)}));this.service=new st}},k=L;var xt=(s,t,e)=>a(void 0,null,function*(){if(rt(s))e();else return t.status(i.UNAUTHORIZED).json({status:"ERROR",message:"unauthorized user"})}),_=xt;var ot=require("express"),S=(0,ot.Router)(),O=new k;S.post("/signup",O.signup);S.post("/login",O.login);S.post("/address",_,O.address);S.get("/profile",_,O.profile);S.get("/shopping-details",_,O.shoppingDetails);S.get("/wishlist",_,O.wishlist);S.post("/app-events",O.events);var M=S;var Tt=(s,t,e,r)=>a(void 0,null,function*(){let o=new x;if(process.on("uncaughtException",n=>{throw console.log(n,"UNHANDLED"),n}),process.on("uncaughtException",n=>{o.logError(n),o.isTrustError(s)}),s){if(yield o.logError(s),o.isTrustError(s)){if(s.errorStack){let n=s.errorStack;return e.status(s.statusCode).json({message:n})}return e.status(s.statusCode).json({message:s.message})}return e.status(s.statusCode).json({message:s.message})}r()}),nt=Tt;var E=(0,T.default)();E.use((0,ut.default)());E.use(T.default.json({limit:"1mb"}));E.use(T.default.urlencoded({extended:!0,limit:"1mb"}));E.use((0,at.default)());E.use((0,it.default)());E.use((s,t,e)=>{R.info(`${s.method} => ${s.path}`),e()});E.use("/customer",N);E.use("/customer",M);E.use(nt);var ct=E;var Nt=()=>{b(),ct.listen(y.PORT,()=>{R.info(`customer service is running on PORT: ${y.PORT}`)}).on("error",()=>{R.error("Failed to start server"),process.exit()})};Nt();
